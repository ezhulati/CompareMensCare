---
import {
  Heart,
  Sparkles,
  Activity,
  TrendingDown,
  Brain,
  Stethoscope,
  UserPlus,
  ArrowLeftRight,
  DollarSign,
  Shield,
  ShieldCheck,
  Zap,
  CircleDollarSign,
  TrendingUp,
  Calendar,
  Layers,
  Lock,
  Clock,
  CalendarDays,
  CalendarCheck
} from 'lucide-astro';

interface Category {
  id: string;
  label: string;
  description: string;
}

const categories: Category[] = [
  {
    id: 'sexual-health',
    label: 'Sexual Health',
    description: 'ED treatments & sexual wellness',
  },
  {
    id: 'hair-health',
    label: 'Hair Health',
    description: 'Hair loss treatments',
  },
  {
    id: 'testosterone',
    label: 'Testosterone',
    description: 'TRT & hormone optimization',
  },
  {
    id: 'weight-loss',
    label: 'Weight Loss',
    description: 'GLP-1 & weight management',
  },
  {
    id: 'mental-health',
    label: 'Mental Health',
    description: 'Therapy & psychiatric care',
  },
  {
    id: 'diagnostics',
    label: 'Diagnostics',
    description: 'At-home health testing',
  },
];

const categoryIcons: Record<string, any> = {
  'sexual-health': Heart,
  'hair-health': Sparkles,
  'testosterone': Activity,
  'weight-loss': TrendingDown,
  'mental-health': Brain,
  'diagnostics': Stethoscope,
};
---

<div class="guided-matcher bg-white rounded-3xl border border-slate-200 p-8 lg:p-12 shadow-sm">
  <!-- Progress Bar -->
  <div class="max-w-md mx-auto mb-8">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm font-medium text-slate-700">Question <span id="progress-current">1</span> of <span id="progress-total">3</span></span>
      <span class="text-sm text-slate-500"><span id="progress-percent">33</span>% complete</span>
    </div>
    <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
      <div id="progress-bar" class="h-full bg-brand-accent transition-all duration-300" style="width: 33%"></div>
    </div>
  </div>

  <!-- Question 1: Category Selection -->
  <div id="question-1" class="question-step active">
    <div class="text-center mb-10">
      <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-3">
        What brings you here today?
      </h2>
      <p class="text-lg text-slate-600 max-w-2xl mx-auto">
        Choose the health topic you're interested in exploring
      </p>
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 max-w-4xl mx-auto">
      {categories.map((category) => {
        const IconComponent = categoryIcons[category.id];
        return (
          <button
            type="button"
            data-category={category.id}
            class="category-card group relative card-hover p-6 text-center cursor-pointer transition-all duration-200 focus-ring"
          >
            <div class="flex justify-center mb-3 text-brand-accent transition-transform duration-200 group-hover:scale-110">
              <IconComponent class="w-12 h-12" />
            </div>
            <h3 class="font-semibold text-slate-900 mb-1 group-hover:text-brand-accent transition-colors">
              {category.label}
            </h3>
            <p class="text-sm text-slate-600">
              {category.description}
            </p>
          </button>
        );
      })}
    </div>
  </div>

  <!-- Question 2: Experience Level (Sexual Health) -->
  <div id="question-2-sexual" class="question-step hidden">
    <div class="text-center mb-10">
      <button type="button" class="back-btn text-sm text-slate-500 hover:text-slate-700 mb-4 inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      </button>
      <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-3">
        Have you tried online ED treatment before?
      </h2>
      <p class="text-lg text-slate-600 max-w-2xl mx-auto">
        This helps us understand your experience level
      </p>
    </div>

    <div class="grid md:grid-cols-3 gap-4 max-w-3xl mx-auto">
      <button
        type="button"
        data-experience="novice"
        class="experience-card card-hover p-6 text-center cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex justify-center mb-3 text-emerald-600">
          <UserPlus class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">First Timer</h3>
        <p class="text-sm text-slate-600">
          I'm exploring this for the first time
        </p>
      </button>

      <button
        type="button"
        data-experience="comparison"
        class="experience-card card-hover p-6 text-center cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex justify-center mb-3 text-blue-600">
          <ArrowLeftRight class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Switching Services</h3>
        <p class="text-sm text-slate-600">
          I've used a service but want to compare options
        </p>
      </button>

      <button
        type="button"
        data-experience="price"
        class="experience-card card-hover p-6 text-center cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex justify-center mb-3 text-emerald-600">
          <DollarSign class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Finding Value</h3>
        <p class="text-sm text-slate-600">
          I'm looking for the best price
        </p>
      </button>
    </div>
  </div>

  <!-- Question 3a: Novice Concerns -->
  <div id="question-3-novice" class="question-step hidden">
    <div class="text-center mb-10">
      <button type="button" class="back-btn text-sm text-slate-500 hover:text-slate-700 mb-4 inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      </button>
      <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-3">
        What matters most to you?
      </h2>
      <p class="text-lg text-slate-600 max-w-2xl mx-auto">
        Choose your top priority
      </p>
    </div>

    <div class="grid md:grid-cols-2 gap-4 max-w-2xl mx-auto">
      <button
        type="button"
        data-concern="privacy"
        class="concern-card card-hover p-6 text-left cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex mb-3 text-purple-600">
          <Shield class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Privacy & Discretion</h3>
        <p class="text-sm text-slate-600">
          I want this to stay completely private
        </p>
      </button>

      <button
        type="button"
        data-concern="safety"
        class="concern-card card-hover p-6 text-left cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex mb-3 text-blue-600">
          <ShieldCheck class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Safety & Trust</h3>
        <p class="text-sm text-slate-600">
          I want to make sure this is safe and legitimate
        </p>
      </button>

      <button
        type="button"
        data-concern="ease"
        class="concern-card card-hover p-6 text-left cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex mb-3 text-amber-600">
          <Zap class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Easy Process</h3>
        <p class="text-sm text-slate-600">
          I want the simplest, most straightforward option
        </p>
      </button>

      <button
        type="button"
        data-concern="cost"
        class="concern-card card-hover p-6 text-left cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex mb-3 text-emerald-600">
          <CircleDollarSign class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Affordable Cost</h3>
        <p class="text-sm text-slate-600">
          I'm looking for the best value for my money
        </p>
      </button>
    </div>
  </div>

  <!-- Question 3b: Comparison Concerns -->
  <div id="question-3-comparison" class="question-step hidden">
    <div class="text-center mb-10">
      <button type="button" class="back-btn text-sm text-slate-500 hover:text-slate-700 mb-4 inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      </button>
      <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-3">
        What didn't you love about your previous service?
      </h2>
      <p class="text-lg text-slate-600 max-w-2xl mx-auto">
        This helps us find a better match
      </p>
    </div>

    <div class="grid md:grid-cols-2 gap-4 max-w-2xl mx-auto">
      <button
        type="button"
        data-concern="price-high"
        class="concern-card card-hover p-6 text-left cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex mb-3 text-red-600">
          <TrendingUp class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Too Expensive</h3>
        <p class="text-sm text-slate-600">
          I need a more affordable option
        </p>
      </button>

      <button
        type="button"
        data-concern="flexibility"
        class="concern-card card-hover p-6 text-left cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex mb-3 text-blue-600">
          <Calendar class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Lack of Flexibility</h3>
        <p class="text-sm text-slate-600">
          I want more control over orders and timing
        </p>
      </button>

      <button
        type="button"
        data-concern="selection"
        class="concern-card card-hover p-6 text-left cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex mb-3 text-indigo-600">
          <Layers class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Limited Options</h3>
        <p class="text-sm text-slate-600">
          I want more treatment choices
        </p>
      </button>

      <button
        type="button"
        data-concern="privacy-compare"
        class="concern-card card-hover p-6 text-left cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex mb-3 text-purple-600">
          <Lock class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Privacy Concerns</h3>
        <p class="text-sm text-slate-600">
          I want more discreet packaging or billing
        </p>
      </button>
    </div>
  </div>

  <!-- Question 3c: Price Focus -->
  <div id="question-3-price" class="question-step hidden">
    <div class="text-center mb-10">
      <button type="button" class="back-btn text-sm text-slate-500 hover:text-slate-700 mb-4 inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      </button>
      <h2 class="text-3xl lg:text-4xl font-bold text-slate-900 mb-3">
        How often do you plan to use this?
      </h2>
      <p class="text-lg text-slate-600 max-w-2xl mx-auto">
        This affects which pricing model works best for you
      </p>
    </div>

    <div class="grid md:grid-cols-3 gap-4 max-w-3xl mx-auto">
      <button
        type="button"
        data-concern="occasional"
        class="concern-card card-hover p-6 text-center cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex justify-center mb-3 text-slate-600">
          <Clock class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Occasionally</h3>
        <p class="text-sm text-slate-600">
          A few times per month
        </p>
      </button>

      <button
        type="button"
        data-concern="regular"
        class="concern-card card-hover p-6 text-center cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex justify-center mb-3 text-blue-600">
          <CalendarDays class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Regularly</h3>
        <p class="text-sm text-slate-600">
          Several times per week
        </p>
      </button>

      <button
        type="button"
        data-concern="daily"
        class="concern-card card-hover p-6 text-center cursor-pointer transition-all duration-200 focus-ring group"
      >
        <div class="flex justify-center mb-3 text-emerald-600">
          <CalendarCheck class="w-12 h-12" />
        </div>
        <h3 class="font-semibold text-lg text-slate-900 mb-2 group-hover:text-brand-accent transition-colors">Daily</h3>
        <p class="text-sm text-slate-600">
          Every day or almost daily
        </p>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loading-state" class="hidden text-center py-12">
    <svg class="animate-spin h-12 w-12 mx-auto mb-4 text-brand-accent" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <h3 class="text-xl font-semibold text-slate-900 mb-2">Finding Your Perfect Match...</h3>
    <p class="text-slate-600">Analyzing your answers and comparing services</p>
  </div>
</div>

<style>
  .question-step {
    display: none;
  }

  .question-step.active {
    display: block;
  }

  .category-card:hover,
  .experience-card:hover,
  .concern-card:hover {
    transform: translateY(-2px);
  }
</style>

<script>
  interface UserChoices {
    category?: string;
    experience?: string;
    concern?: string;
  }

  function initGuidedMatcher() {
    const userChoices: UserChoices = {};
    let currentStep = 1;
    const totalSteps = 3;

    // Progress tracking
    function updateProgress(step: number) {
      currentStep = step;
      const percent = Math.round((step / totalSteps) * 100);

      const progressBar = document.getElementById('progress-bar');
      const progressCurrent = document.getElementById('progress-current');
      const progressPercent = document.getElementById('progress-percent');

      if (progressBar) progressBar.style.width = `${percent}%`;
      if (progressCurrent) progressCurrent.textContent = String(step);
      if (progressPercent) progressPercent.textContent = String(percent);
    }

    // Show specific question step
    function showStep(stepId: string) {
      document.querySelectorAll('.question-step').forEach(step => {
        step.classList.remove('active');
      });

      const targetStep = document.getElementById(stepId);
      if (targetStep) {
        targetStep.classList.add('active');
      }
    }

    // Question 1: Category Selection
    document.querySelectorAll('.category-card').forEach(card => {
      card.addEventListener('click', () => {
        const category = card.getAttribute('data-category');
        if (!category) return;

        userChoices.category = category;
        updateProgress(2);

        // For now, only sexual-health has full flow
        if (category === 'sexual-health') {
          showStep('question-2-sexual');
        } else {
          // For other categories, skip to results with basic selection
          userChoices.experience = 'general';
          userChoices.concern = 'overview';
          showResults();
        }

        // Analytics
        if (typeof window !== 'undefined' && (window as any).gtag) {
          (window as any).gtag('event', 'guide_category_selected', {
            category: category,
          });
        }
      });
    });

    // Question 2: Experience Level
    document.querySelectorAll('.experience-card').forEach(card => {
      card.addEventListener('click', () => {
        const experience = card.getAttribute('data-experience');
        if (!experience) return;

        userChoices.experience = experience;
        updateProgress(3);

        // Show appropriate question 3
        if (experience === 'novice') {
          showStep('question-3-novice');
        } else if (experience === 'comparison') {
          showStep('question-3-comparison');
        } else if (experience === 'price') {
          showStep('question-3-price');
        }

        // Analytics
        if (typeof window !== 'undefined' && (window as any).gtag) {
          (window as any).gtag('event', 'guide_experience_selected', {
            experience: experience,
          });
        }
      });
    });

    // Question 3: Concerns (all variants)
    document.querySelectorAll('.concern-card').forEach(card => {
      card.addEventListener('click', () => {
        const concern = card.getAttribute('data-concern');
        if (!concern) return;

        userChoices.concern = concern;

        // Show results
        showResults();

        // Analytics
        if (typeof window !== 'undefined' && (window as any).gtag) {
          (window as any).gtag('event', 'guide_concern_selected', {
            concern: concern,
          });
        }
      });
    });

    // Back button handling
    document.querySelectorAll('.back-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const currentQuestion = document.querySelector('.question-step.active');
        if (!currentQuestion) return;

        const currentId = currentQuestion.id;

        if (currentId.startsWith('question-3')) {
          // Go back to question 2
          showStep('question-2-sexual');
          updateProgress(2);
          delete userChoices.concern;
        } else if (currentId === 'question-2-sexual') {
          // Go back to question 1
          showStep('question-1');
          updateProgress(1);
          delete userChoices.experience;
        }
      });
    });

    // Show results
    function showResults() {
      // Hide all questions
      document.querySelectorAll('.question-step').forEach(step => {
        step.classList.remove('active');
      });

      // Show loading state
      const loadingState = document.getElementById('loading-state');
      if (loadingState) {
        loadingState.classList.remove('hidden');
      }

      // Save to session storage
      sessionStorage.setItem('guidedChoices', JSON.stringify(userChoices));

      // Trigger results display (to be handled by PersonalizedResults component)
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('guided-complete', {
          detail: userChoices
        }));
      }, 1500);
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGuidedMatcher);
  } else {
    initGuidedMatcher();
  }

  // Support Astro view transitions
  document.addEventListener('astro:page-load', initGuidedMatcher);
</script>
