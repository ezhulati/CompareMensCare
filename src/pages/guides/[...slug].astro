---
import { getCollection, getEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BreadcrumbSchema from '../../components/BreadcrumbSchema.astro';
import AuthorSchema from '../../components/AuthorSchema.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import QuickSummary from '../../components/QuickSummary.astro';
import HowWeResearch from '../../components/HowWeResearch.astro';
import FAQSection from '../../components/FAQSection.astro';
import KeyTakeaways from '../../components/KeyTakeaways.astro';
import { formatDate, getCategoryName } from '../../utils/helpers';
import { getAuthorByName } from '../../data/authors';

// Enable prerendering for all guide pages (faster, better SEO)
export const prerender = true;

export async function getStaticPaths() {
  const guides = await getCollection('guides');
  return guides.map((guide) => ({
    params: { slug: guide.slug },
    props: { guide },
  }));
}

const { guide } = Astro.props;
const { Content } = await guide.render();

// Get author data for headshot
const authorData = getAuthorByName(guide.data.writtenBy);
const medicalReviewerData = getAuthorByName(guide.data.medicalReviewer || '');

// Article Schema for SEO
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: guide.data.title,
  description: guide.data.description,
  image: guide.data.image || 'https://comparemenscare.com/og-image.png',
  datePublished: guide.data.publishDate.toISOString(),
  dateModified: guide.data.lastReviewed.toISOString(),
  author: {
    '@type': 'Person',
    name: guide.data.author,
  },
  publisher: {
    '@type': 'Organization',
    name: 'CompareMensCare',
    logo: {
      '@type': 'ImageObject',
      url: 'https://comparemenscare.com/logo.png',
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://comparemenscare.com/guides/${guide.slug}`,
  },
  ...(guide.data.medicalReviewer && {
    reviewedBy: {
      '@type': 'Person',
      name: guide.data.medicalReviewer,
    },
  }),
};
---

<BaseLayout
  title={guide.data.title}
  description={guide.data.description}
  type="article"
  publishDate={guide.data.publishDate}
  author={guide.data.author}
  schema={articleSchema}
>
  <!-- Breadcrumb Schema -->
  <BreadcrumbSchema items={[
    { name: 'Home', url: '/' },
    { name: 'Guides', url: '/guides' },
    { name: guide.data.title, url: `/guides/${guide.slug}` },
  ]} />

  <!-- Author Schema -->
  <AuthorSchema
    name={guide.data.writtenBy}
    credentials={guide.data.writtenByCredentials}
    role="author"
  />

  <!-- Medical Reviewer Schema -->
  <AuthorSchema
    name={guide.data.medicalReviewer}
    credentials={guide.data.medicalReviewerCredentials}
    role="reviewer"
  />

  <!-- Article Header -->
  <article class="py-12 bg-white">
    <div class="container-custom max-w-4xl">
      <!-- Category Badge -->
      <div class="mb-6 px-4">
        <a
          href={`/${guide.data.category}`}
          class="inline-block px-3 py-1 text-sm font-medium text-brand-accent bg-brand-accent/10 rounded-full hover:bg-brand-accent/20 transition-colors"
        >
          {getCategoryName(guide.data.category)}
        </a>
      </div>

      <!-- Title -->
      <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-slate-900 mb-4 sm:mb-6 leading-tight px-4">
        {guide.data.title}
      </h1>

      <!-- Meta Info -->
      <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 mb-8 pb-8 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="font-medium">
            Written by <a href={`/authors/${guide.data.writtenBy.toLowerCase().replace(/ /g, '-')}`} class="text-brand-accent hover:underline">{guide.data.writtenBy}</a>, {guide.data.writtenByCredentials}
          </span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span>Updated {formatDate(guide.data.lastReviewed)}</span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="text-emerald-600 font-medium">
            Medically reviewed by <a href="/authors/amara-okonkwo" class="text-emerald-700 hover:underline">{guide.data.medicalReviewer}</a>, {guide.data.medicalReviewerCredentials}
          </span>
        </div>
      </div>

      <!-- Quick Summary (AI-SEO Optimization) -->
      {guide.data.summary && guide.data.summaryPoints && (
        <div class="mb-8">
          <QuickSummary
            summary={guide.data.summary}
            points={guide.data.summaryPoints}
          />
        </div>
      )}

      <!-- How We Research (AI-SEO Optimization) -->
      {guide.data.researchHours && guide.data.sourcesReviewed && (
        <div class="mb-8">
          <HowWeResearch
            hoursSpent={guide.data.researchHours}
            sourcesReviewed={guide.data.sourcesReviewed}
            lastUpdated={guide.data.lastReviewed}
            compact={false}
          />
        </div>
      )}

      <!-- Article Content -->
      <div class="prose prose-lg max-w-none">
        <Content />
      </div>

      <!-- Key Takeaways (AI-SEO Optimization) -->
      {guide.data.keyTakeaways && guide.data.keyTakeaways.length > 0 && (
        <div class="mt-12">
          <KeyTakeaways takeaways={guide.data.keyTakeaways} />
        </div>
      )}

      <!-- Author Bio (Extended) -->
      <div class="mt-12 p-6 bg-slate-50 rounded-lg border border-slate-200">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <a href={`/authors/${guide.data.writtenBy.toLowerCase().replace(/ /g, '-')}`}>
              {authorData?.image ? (
                <img
                  src={authorData.image}
                  alt={guide.data.writtenBy}
                  class="w-16 h-16 rounded-full object-cover hover:opacity-90 transition-opacity"
                />
              ) : (
                <div class="w-16 h-16 bg-gradient-to-br from-brand-accent to-brand-primary rounded-full flex items-center justify-center text-white font-bold text-xl hover:opacity-90 transition-opacity">
                  {guide.data.writtenBy.split(' ').map(n => n[0]).join('')}
                </div>
              )}
            </a>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-slate-900 mb-1">
              <a href={`/authors/${guide.data.writtenBy.toLowerCase().replace(/ /g, '-')}`} class="hover:text-brand-accent">{guide.data.writtenBy}</a>
            </h3>
            <p class="text-sm text-slate-600 mb-2">{guide.data.writtenByCredentials}</p>
            <p class="text-sm text-slate-700">
              Medical review by <a href="/authors/amara-okonkwo" class="text-emerald-600 hover:underline">{guide.data.medicalReviewer}</a>, {guide.data.medicalReviewerCredentials}
            </p>
            <a href={`/authors/${guide.data.writtenBy.toLowerCase().replace(/ /g, '-')}`} class="inline-block mt-3 text-sm text-brand-accent hover:underline">
              View full profile â†’
            </a>
          </div>
        </div>
      </div>

      <!-- FAQ Section (AI-SEO Optimization with Schema Markup) -->
      {guide.data.faqs && guide.data.faqs.length > 0 && (
        <div class="mt-12">
          <FAQSection
            title={`Common Questions About ${guide.data.faqTitle || guide.data.title}`}
            categoryName={guide.data.faqCategory || getCategoryName(guide.data.category)}
            faqs={guide.data.faqs}
          />
        </div>
      )}

      <!-- Citations -->
      {guide.data.citations && guide.data.citations.length > 0 && (
        <div class="mt-12 pt-8 border-t border-slate-200">
          <h3 class="text-xl font-bold text-slate-900 mb-4">References</h3>
          <ol class="space-y-2 text-sm text-slate-600">
            {guide.data.citations.map((citation, index) => (
              <li class="pl-2">
                <span class="font-medium">{index + 1}.</span>{' '}
                {citation.url ? (
                  <a href={citation.url} target="_blank" rel="noopener noreferrer" class="text-brand-accent hover:underline">
                    {citation.title}
                  </a>
                ) : (
                  citation.title
                )}
                {' - '}
                <span class="text-slate-500">{citation.source}</span>
              </li>
            ))}
          </ol>
        </div>
      )}
    </div>
  </article>

  <!-- CTA Section -->
  <section class="section bg-slate-50 border-t border-slate-200">
    <div class="container-custom max-w-4xl text-center">
      <h2 class="text-3xl font-bold text-slate-900 mb-4">
        Ready to Find Your Best Match?
      </h2>
      <p class="text-base sm:text-lg lg:text-xl text-slate-600 mb-6 sm:mb-8 max-w-2xl mx-auto px-4">
        Use our personalized matcher to find the right telehealth service for your needs.
      </p>
      <a href="/#matcher" class="btn-primary inline-flex items-center gap-2">
        Find Your Match
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
      </a>
    </div>
  </section>
</BaseLayout>
