---
import { getCollection, getEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BreadcrumbSchema from '../../components/BreadcrumbSchema.astro';
import AuthorSchema from '../../components/AuthorSchema.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import QuickSummary from '../../components/QuickSummary.astro';
import HowWeResearch from '../../components/HowWeResearch.astro';
import FAQSection from '../../components/FAQSection.astro';
import KeyTakeaways from '../../components/KeyTakeaways.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import QuickNav from '../../components/QuickNav.astro';
import TheAnswer from '../../components/TheAnswer.astro';
import TreatmentOptions from '../../components/TreatmentOptions.astro';
import QualificationChecker from '../../components/QualificationChecker.astro';
import ExpandableSection from '../../components/ExpandableSection.astro';
import EmbeddedMatcher from '../../components/EmbeddedMatcher.astro';
import { formatDate, getCategoryName } from '../../utils/helpers';
import { getAuthorByName } from '../../data/authors';

// Enable prerendering for all guide pages (faster, better SEO)
export const prerender = true;

export async function getStaticPaths() {
  const guides = await getCollection('guides');
  return guides.map((guide) => ({
    params: { slug: guide.slug },
    props: { guide },
  }));
}

const { guide } = Astro.props;
const { Content, headings } = await guide.render();

// Get author data for headshot
const authorData = getAuthorByName(guide.data.writtenBy);
const medicalReviewerData = getAuthorByName(guide.data.medicalReviewer || '');

// Article Schema for SEO
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: guide.data.title,
  description: guide.data.description,
  image: guide.data.image || 'https://comparemenscare.com/og-image.png',
  datePublished: guide.data.publishDate.toISOString(),
  dateModified: guide.data.lastReviewed.toISOString(),
  author: {
    '@type': 'Person',
    name: guide.data.author,
  },
  publisher: {
    '@type': 'Organization',
    name: 'CompareMensCare',
    logo: {
      '@type': 'ImageObject',
      url: 'https://comparemenscare.com/logo.png',
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://comparemenscare.com/guides/${guide.slug}`,
  },
  ...(guide.data.medicalReviewer && {
    reviewedBy: {
      '@type': 'Person',
      name: guide.data.medicalReviewer,
    },
  }),
};
---

<BaseLayout
  title={guide.data.title}
  description={guide.data.description}
  type="article"
  publishDate={guide.data.publishDate}
  author={guide.data.author}
  schema={articleSchema}
>
  <!-- Breadcrumb Schema -->
  <BreadcrumbSchema items={[
    { name: 'Home', url: '/' },
    { name: 'Guides', url: '/guides' },
    { name: guide.data.title, url: `/guides/${guide.slug}` },
  ]} />

  <!-- Author Schema -->
  <AuthorSchema
    name={guide.data.writtenBy}
    credentials={guide.data.writtenByCredentials}
    role="author"
  />

  <!-- Medical Reviewer Schema -->
  <AuthorSchema
    name={guide.data.medicalReviewer}
    credentials={guide.data.medicalReviewerCredentials}
    role="reviewer"
  />

  <!-- Article Header -->
  <article class="py-12 bg-white">
    <div class="container-custom max-w-7xl">
      <!-- Mobile TOC -->
      <div class="lg:hidden max-w-4xl mx-auto px-4">
        <TableOfContents headings={headings} />
      </div>

      <!-- 2-Column Layout: Content + Sidebar TOC -->
      <div class="lg:grid lg:grid-cols-12 lg:gap-8">
        <!-- Main Content Column -->
        <div class="lg:col-span-8 max-w-4xl">
      <!-- Category Badge -->
      <div class="mb-6 px-4">
        <a
          href={`/${guide.data.category}`}
          class="inline-block px-3 py-1 text-sm font-medium text-brand-accent bg-brand-accent/10 rounded-full hover:bg-brand-accent/20 transition-colors"
        >
          {getCategoryName(guide.data.category)}
        </a>
      </div>

      <!-- Title -->
      {guide.data.title.includes(':') ? (
        <div class="px-4 mb-4 sm:mb-6">
          <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-slate-900 leading-tight">
            {guide.data.title.split(':')[0].trim()}
          </h1>
          <p class="text-xl sm:text-2xl md:text-3xl text-slate-600 mt-2 sm:mt-3 leading-snug">
            {guide.data.title.split(':')[1].trim()}
          </p>
        </div>
      ) : (
        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-slate-900 mb-4 sm:mb-6 leading-tight px-4">
          {guide.data.title}
        </h1>
      )}

      <!-- Meta Info -->
      <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600 mb-8 pb-8 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="font-medium">
            Written by <a href={`/authors/${guide.data.writtenBy.toLowerCase().replace(/ /g, '-')}`} class="text-brand-accent hover:underline">{guide.data.writtenBy}</a>, {guide.data.writtenByCredentials}
          </span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span>Updated {formatDate(guide.data.lastReviewed)}</span>
        </div>
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="text-emerald-600 font-medium">
            Medically reviewed by <a href="/authors/amara-okonkwo" class="text-emerald-700 hover:underline">{guide.data.medicalReviewer}</a>, {guide.data.medicalReviewerCredentials}
          </span>
        </div>
      </div>

      <!-- Quick Nav (Decision-First Guides) -->
      {guide.data.quickNavSections && guide.data.quickNavSections.length > 0 && (
        <QuickNav sections={guide.data.quickNavSections} />
      )}

      <!-- The Answer (Decision-First Guides) -->
      {guide.data.quickAnswer && (
        <TheAnswer
          question={guide.data.title.includes(':') ? guide.data.title.split(':')[0].trim() + '?' : `What should I know about ${guide.data.title}?`}
          answer={guide.data.quickAnswer}
          tldr={guide.data.tldrPoints}
          cta={guide.data.primaryCTA}
          timeToRead={guide.data.timeToRead}
        />
      )}

      <!-- Treatment Options (Decision-First Guides) -->
      {(guide.data.treatmentOptions || guide.data.topServices) && (
        <TreatmentOptions
          title="Your Treatment Options"
          description="Compare effectiveness, speed, cost, and availability of different approaches"
          comparisonTable={guide.data.treatmentOptions}
          topServices={guide.data.topServices}
          showComparison={guide.data.treatmentOptions && guide.data.treatmentOptions.length > 0}
          showServices={guide.data.topServices && guide.data.topServices.length > 0}
        />
      )}

      <!-- Qualification Checker (Decision-First Guides) -->
      {guide.data.goodCandidateIf && guide.data.notRightIf && (
        <QualificationChecker
          title="Are You a Good Candidate?"
          description="Quickly determine if this treatment approach is right for you"
          goodCandidateIf={guide.data.goodCandidateIf}
          notRightIf={guide.data.notRightIf}
          whenToSeeDoctorTitle={guide.data.whenToSeeDoctorTitle}
          whenToSeeDoctor={guide.data.whenToSeeDoctor}
          ctaText={guide.data.primaryCTA?.text}
          ctaHref={guide.data.primaryCTA?.href}
        />
      )}

      <!-- Quick Summary (Legacy - AI-SEO Optimization) -->
      {!guide.data.quickAnswer && guide.data.summary && guide.data.summaryPoints && (
        <div class="mb-8">
          <QuickSummary
            summary={guide.data.summary}
            points={guide.data.summaryPoints}
          />
        </div>
      )}

      <!-- How We Research (AI-SEO Optimization) -->
      {guide.data.researchHours && guide.data.sourcesReviewed && (
        <div class="mb-8">
          <HowWeResearch
            hoursSpent={guide.data.researchHours}
            sourcesReviewed={guide.data.sourcesReviewed}
            lastUpdated={guide.data.lastReviewed}
            compact={false}
          />
        </div>
      )}

      <!-- Article Content -->
      <div class="prose prose-lg max-w-none" id="guide-content">
        <Content />
      </div>

      <!-- Client-side script to wrap educational sections in expandable components -->
      {guide.data.educationalSections && guide.data.educationalSections.length > 0 && (
        <script define:vars={{ educationalSections: guide.data.educationalSections }}>
          document.addEventListener('DOMContentLoaded', () => {
            educationalSections.forEach((sectionMeta) => {
              const sectionDiv = document.getElementById(sectionMeta.id);
              if (!sectionDiv) return;

              // Create wrapper
              const wrapper = document.createElement('div');
              wrapper.className = `expandable-section border-2 rounded-xl overflow-hidden mb-6 transition-all ${
                sectionMeta.variant === 'educational' ? 'border-blue-200 bg-blue-50/30' :
                sectionMeta.variant === 'technical' ? 'border-purple-200 bg-purple-50/30' :
                'border-gray-200 bg-white'
              }`;
              wrapper.setAttribute('data-section-id', sectionMeta.id);

              // Create header
              const header = document.createElement('button');
              header.type = 'button';
              header.className = `expandable-header w-full px-6 py-5 flex items-center justify-between transition-colors ${
                sectionMeta.variant === 'educational' ? 'bg-blue-50 hover:bg-blue-100' :
                sectionMeta.variant === 'technical' ? 'bg-purple-50 hover:bg-purple-100' :
                'bg-gray-50 hover:bg-gray-100'
              }`;
              header.setAttribute('aria-expanded', sectionMeta.defaultExpanded ? 'true' : 'false');
              header.setAttribute('aria-controls', `${sectionMeta.id}-content`);

              const headerContent = document.createElement('div');
              headerContent.className = 'flex items-center gap-3 flex-1 text-left';

              if (sectionMeta.badge) {
                const badge = document.createElement('span');
                badge.className = 'bg-brand-accent text-white text-xs font-bold px-2.5 py-1 rounded-full';
                badge.textContent = sectionMeta.badge;
                headerContent.appendChild(badge);
              }

              const titleDiv = document.createElement('div');
              titleDiv.className = 'flex-1';

              const title = document.createElement('h3');
              title.className = 'text-xl font-bold text-gray-900 mb-1';
              title.textContent = sectionMeta.title;
              titleDiv.appendChild(title);

              if (sectionMeta.summary) {
                const summary = document.createElement('p');
                summary.className = 'text-sm text-gray-600 leading-relaxed';
                summary.textContent = sectionMeta.summary;
                titleDiv.appendChild(summary);
              }

              headerContent.appendChild(titleDiv);
              header.appendChild(headerContent);

              const icon = document.createElement('div');
              icon.className = 'ml-4 flex-shrink-0';
              icon.innerHTML = `<svg class="expandable-icon w-6 h-6 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`;
              header.appendChild(icon);

              // Create content wrapper
              const contentWrapper = document.createElement('div');
              contentWrapper.id = `${sectionMeta.id}-content`;
              contentWrapper.className = 'expandable-content';
              contentWrapper.style.maxHeight = sectionMeta.defaultExpanded ? 'none' : '0';
              contentWrapper.style.overflow = sectionMeta.defaultExpanded ? 'visible' : 'hidden';

              const contentInner = document.createElement('div');
              contentInner.className = 'px-6 py-6 prose prose-lg max-w-none';
              contentInner.innerHTML = sectionDiv.innerHTML;
              contentWrapper.appendChild(contentInner);

              // Assemble wrapper
              wrapper.appendChild(header);
              wrapper.appendChild(contentWrapper);

              // Replace original div
              sectionDiv.parentNode.replaceChild(wrapper, sectionDiv);

              // Add click handler
              header.addEventListener('click', () => {
                const isExpanded = header.getAttribute('aria-expanded') === 'true';

                if (isExpanded) {
                  header.setAttribute('aria-expanded', 'false');
                  contentWrapper.style.maxHeight = '0';
                  contentWrapper.style.overflow = 'hidden';
                  icon.querySelector('svg').style.transform = 'rotate(0deg)';
                } else {
                  header.setAttribute('aria-expanded', 'true');
                  contentWrapper.style.maxHeight = contentWrapper.scrollHeight + 'px';
                  contentWrapper.style.overflow = 'visible';
                  icon.querySelector('svg').style.transform = 'rotate(180deg)';

                  setTimeout(() => {
                    if (header.getAttribute('aria-expanded') === 'true') {
                      contentWrapper.style.maxHeight = 'none';
                    }
                  }, 400);
                }
              });

              // Set initial icon rotation
              if (sectionMeta.defaultExpanded) {
                icon.querySelector('svg').style.transform = 'rotate(180deg)';
              }
            });
          });
        </script>
      )}

      <!-- Key Takeaways (AI-SEO Optimization) -->
      {guide.data.keyTakeaways && guide.data.keyTakeaways.length > 0 && (
        <div class="mt-12">
          <KeyTakeaways takeaways={guide.data.keyTakeaways} />
        </div>
      )}

      <!-- Author Bio (Extended) -->
      <div class="mt-12 p-6 bg-slate-50 rounded-lg border border-slate-200">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <a href={`/authors/${guide.data.writtenBy.toLowerCase().replace(/ /g, '-')}`}>
              {authorData?.image ? (
                <img
                  src={authorData.image}
                  alt={guide.data.writtenBy}
                  class="w-16 h-16 rounded-full object-cover hover:opacity-90 transition-opacity"
                />
              ) : (
                <div class="w-16 h-16 bg-gradient-to-br from-brand-accent to-brand-primary rounded-full flex items-center justify-center text-white font-bold text-xl hover:opacity-90 transition-opacity">
                  {guide.data.writtenBy.split(' ').map(n => n[0]).join('')}
                </div>
              )}
            </a>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-slate-900 mb-1">
              <a href={`/authors/${guide.data.writtenBy.toLowerCase().replace(/ /g, '-')}`} class="hover:text-brand-accent">{guide.data.writtenBy}</a>
            </h3>
            <p class="text-sm text-slate-600 mb-2">{guide.data.writtenByCredentials}</p>
            <p class="text-sm text-slate-700">
              Medical review by <a href="/authors/amara-okonkwo" class="text-emerald-600 hover:underline">{guide.data.medicalReviewer}</a>, {guide.data.medicalReviewerCredentials}
            </p>
            <a href={`/authors/${guide.data.writtenBy.toLowerCase().replace(/ /g, '-')}`} class="inline-block mt-3 text-sm text-brand-accent hover:underline">
              View full profile â†’
            </a>
          </div>
        </div>
      </div>

      <!-- FAQ Section (AI-SEO Optimization with Schema Markup) -->
      {guide.data.faqs && guide.data.faqs.length > 0 && (
        <div class="mt-12">
          <FAQSection
            title={`Common Questions About ${guide.data.faqTitle || guide.data.title}`}
            categoryName={guide.data.faqCategory || getCategoryName(guide.data.category)}
            faqs={guide.data.faqs}
          />
        </div>
      )}

      <!-- Citations -->
      {guide.data.citations && guide.data.citations.length > 0 && (
        <div class="mt-12 pt-8 border-t border-slate-200">
          <h3 class="text-xl font-bold text-slate-900 mb-4">References</h3>
          <ol class="space-y-2 text-sm text-slate-600">
            {guide.data.citations.map((citation, index) => (
              <li class="pl-2">
                <span class="font-medium">{index + 1}.</span>{' '}
                {citation.url ? (
                  <a href={citation.url} target="_blank" rel="noopener noreferrer" class="text-brand-accent hover:underline">
                    {citation.title}
                  </a>
                ) : (
                  citation.title
                )}
                {' - '}
                <span class="text-slate-500">{citation.source}</span>
              </li>
            ))}
          </ol>
        </div>
      )}
        </div>
        <!-- End Main Content Column -->

        <!-- TOC Sidebar Column (Desktop Only) -->
        <div class="lg:col-span-4">
          <TableOfContents headings={headings} />
        </div>
      </div>
      <!-- End 2-Column Grid -->
    </div>
  </article>

  <!-- Embedded Matcher Section -->
  <EmbeddedMatcher
    category={guide.data.category}
    title="Find Your Best Match"
    description="Answer 2 quick questions to get personalized service recommendations"
  />
</BaseLayout>
